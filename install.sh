#!/bin/bash

# ??? (root) ????? ???
if [[ $EUID -ne 0 ]]; then
   echo "?? Please run this script as root! (Command: sudo ./install.sh)" 
   exit 1
fi

echo "================================================="
echo "   SCL Dormitory System - Auto Installer v2.1    "
echo "================================================="

# ????? db.php ???????? ????????? ?????
DB_NAME="dormitory_db"
DB_USER="admin"
DB_PASS="Scl@@2017"
DB_HOST="127.0.0.1"

APP_DIR="/var/www/html/dormitory"
SQL_FILE="database.sql"
SOURCE_DIR="dormitory_app"

# ?. ??????? ????? ??? ???????? (??? ????) ???? ???
echo "? [1/6] Updating system and preparing ports..."
apt update && apt upgrade -y
# ????? ?? ???? ???? ???? ???????? ????? ???? ??? ????? ?????
systemctl stop apache2 2>/dev/null
systemctl disable apache2 2>/dev/null

# ?. ????????? ??????? ?????? (NGINX, MariaDB, PHP)
echo "? [2/6] Installing NGINX, MariaDB, and PHP..."
apt install -y nginx mariadb-server php-fpm php-mysql php-cli php-curl php-gd php-mbstring php-xml php-zip

# ?. ??????? ??? ????? ?????
echo "? [3/6] Setting up Database and User..."
systemctl start mariadb
systemctl enable mariadb

# ??????? ????
mysql -u root -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 'admin' ????? ???? ??? ????????? 'Scl@@2017' ??? ??? (localhost ??? 127.0.0.1 ????? ????)
mysql -u root -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';"
mysql -u root -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'127.0.0.1' IDENTIFIED BY '${DB_PASS}';"

# 'admin' ??????? 'dormitory_db' ?? ?? ??????? ?????
mysql -u root -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';"
mysql -u root -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'127.0.0.1';"
mysql -u root -e "FLUSH PRIVILEGES;"

# SQL ???? ??????? ??? (Collation Error Fix ??)
if [ -f "$SQL_FILE" ]; then
    echo "?? Fixing Collation compatibility in SQL file..."
    # MySQL 8.0 ?? ?????? ?????? ??? ???? ??? ??????? ??? ?????
    sed -i 's/utf8mb4_0900_ai_ci/utf8mb4_unicode_ci/g' "$SQL_FILE"
    
    mysql -u root "$DB_NAME" < "$SQL_FILE"
    echo "? Database imported successfully from $SQL_FILE."
else
    echo "?? WARNING: $SQL_FILE not found! Database created but tables are missing."
fi

# ?. ????????? ???? ?????? ???
echo "? [4/6] Deploying Application Files..."
mkdir -p $APP_DIR
if [ -d "$SOURCE_DIR" ]; then
    cp -r $SOURCE_DIR/* $APP_DIR/
    # ??????? ??????? ??? ??? (???? PHP ???? ???/???? ???? ????)
    chown -R www-data:www-data $APP_DIR
    chmod -R 775 $APP_DIR
    echo "? Files successfully copied to $APP_DIR."
else
    echo "?? WARNING: Source directory '$SOURCE_DIR' not found! Please manually place your PHP files in $APP_DIR."
fi

# ?. NGINX ??????????
echo "? [5/6] Configuring NGINX Server Block..."
# ???????? ?????? ???? PHP ?????? (socket) ?????????????? ????? ??? ???
PHP_SOCK=$(find /run/php/ -name "php*-fpm.sock" | head -n 1)

cat > /etc/nginx/sites-available/dormitory <<EOF
server {
    listen 80;
    server_name _;
    root $APP_DIR;
    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:${PHP_SOCK};
    }

    location ~ /\.ht {
        deny all;
    }
}
EOF

# NGINX ???? ??????????? ???
ln -sf /etc/nginx/sites-available/dormitory /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
systemctl restart nginx

# ?. ????????? ???????
IP_ADDRESS=$(hostname -I | awk '{print $1}')
echo "================================================="
echo " ?? SCL DORMITORY SYSTEM INSTALLATION COMPLETE! ?? "
echo "================================================="
echo "?? Application Directory : $APP_DIR"
echo "???  Database Name        : $DB_NAME"
echo "?? Database User        : $DB_USER"
echo "?? Database Password    : (Set exactly as in your db.php)"
echo "================================================="
echo "?? You can now access your system at: http://${IP_ADDRESS}/"
echo "================================================="
